(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))c(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const n of t.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&c(n)}).observe(document,{childList:!0,subtree:!0});function i(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function c(e){if(e.ep)return;e.ep=!0;const t=i(e);fetch(e.href,t)}})();mdc.ripple.MDCRipple.attachTo(document.querySelector(".mdc-button"));const f={iceServers:[{urls:["stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}],iceCandidatePoolSize:10};let o=null,s=null,l=null,m=null,d=null;function S(){document.querySelector("#cameraBtn").addEventListener("click",b),document.querySelector("#hangupBtn").addEventListener("click",q),document.querySelector("#createBtn").addEventListener("click",h),document.querySelector("#joinBtn").addEventListener("click",C),m=new mdc.dialog.MDCDialog(document.querySelector("#room-dialog"))}async function h(){document.querySelector("#createBtn").disabled=!0,document.querySelector("#joinBtn").disabled=!0;const r=firebase.firestore();if(console.log("Create PeerConnection with configuration: ",f),o=new RTCPeerConnection(f),y(),s)s.getTracks().forEach(e=>{o.addTrack(e,s)});else{console.error("Local stream is undefined");return}const a=await o.createOffer();await o.setLocalDescription(a);const i={offer:{type:a.type,sdp:a.sdp}},c=await r.collection("rooms").add(i);d=c.id,document.querySelector("#currentRoom").innerText=`Current room is ${d} - You are the caller!`,c.onSnapshot(async e=>{const t=e.data();if(!o.currentRemoteDescription&&(t!=null&&t.answer)){const n=new RTCSessionDescription(t.answer);await o.setRemoteDescription(n)}}),g(c,o,"callerCandidates","calleeCandidates")}function C(){document.querySelector("#createBtn").disabled=!0,document.querySelector("#joinBtn").disabled=!0,document.querySelector("#confirmJoinBtn").addEventListener("click",async()=>{d=document.querySelector("#room-id").value,document.querySelector("#currentRoom").innerText=`Current room is ${d} - You are the callee!`,await w(d)},{once:!0}),m.open()}async function w(r){var e;const i=firebase.firestore().collection("rooms").doc(r),c=await i.get();if(c.exists){if(o=new RTCPeerConnection(f),y(),s)s.getTracks().forEach(p=>{o.addTrack(p,s)});else{console.error("Local stream is undefined");return}const t=(e=c.data())==null?void 0:e.offer;if(t)await o.setRemoteDescription(new RTCSessionDescription(t));else{console.error("Offer is undefined");return}const n=await o.createAnswer();await o.setLocalDescription(n);const u={answer:{type:n.type,sdp:n.sdp}};await i.update(u),g(i,o,"calleeCandidates","callerCandidates")}else console.error("Room does not exist")}async function g(r,a,i,c){const e=r.collection(i);a.addEventListener("icecandidate",t=>{t.candidate&&e.add(t.candidate.toJSON())}),r.collection(c).onSnapshot(t=>{t.docChanges().forEach(n=>{if(n.type==="added"){const u=new RTCIceCandidate(n.doc.data());a.addIceCandidate(u)}})})}async function b(){try{const r=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});document.querySelector("#localVideo").srcObject=r,s=r,l=new MediaStream,document.querySelector("#remoteVideo").srcObject=l,document.querySelector("#cameraBtn").disabled=!0,document.querySelector("#joinBtn").disabled=!1,document.querySelector("#createBtn").disabled=!1,document.querySelector("#hangupBtn").disabled=!1}catch(r){console.error("Error accessing user media:",r)}}async function q(){var a;const r=(a=document.querySelector("#localVideo").srcObject)==null?void 0:a.getTracks();if(r&&r.forEach(i=>i.stop()),l&&l.getTracks().forEach(i=>i.stop()),o&&o.close(),document.querySelector("#localVideo").srcObject=null,document.querySelector("#remoteVideo").srcObject=null,document.querySelector("#cameraBtn").disabled=!1,document.querySelector("#joinBtn").disabled=!0,document.querySelector("#createBtn").disabled=!0,document.querySelector("#hangupBtn").disabled=!0,document.querySelector("#currentRoom").innerText="",d){const c=firebase.firestore().collection("rooms").doc(d);(await c.collection("calleeCandidates").get()).forEach(async n=>{await n.ref.delete()}),(await c.collection("callerCandidates").get()).forEach(async n=>{await n.ref.delete()}),await c.delete()}document.location.reload(!0)}function y(){o.addEventListener("icegatheringstatechange",()=>{console.log(`ICE gathering state changed: ${o.iceGatheringState}`)}),o.addEventListener("connectionstatechange",()=>{console.log(`Connection state change: ${o.connectionState}`)}),o.addEventListener("signalingstatechange",()=>{console.log(`Signaling state change: ${o.signalingState}`)}),o.addEventListener("iceconnectionstatechange",()=>{console.log(`ICE connection state change: ${o.iceConnectionState}`)})}S();
